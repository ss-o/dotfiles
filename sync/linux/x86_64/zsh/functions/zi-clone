# -*- mode: zsh; sh-indentation: 2; indent-tabs-mode: nil; sh-basic-offset: 2; -*-
# vim: ft=zsh sw=2 ts=2 et
#
# Description: Clone git repositories in Zi style

builtin emulate -L zsh ${=${options[xtrace]:#off}:+-o xtrace}
builtin setopt extended_glob warn_create_global typeset_silent no_short_loops rc_quotes no_auto_pushd

if [[ $# = 0 ]]; then
  builtin print -Pr "Usage: zi-clone user/repo <path>"
  return 1
elif [[ $# -gt 0 ]]; then
  if [[ -d $ZI[BIN_DIR] ]]; then
    typeset show_process="${ZI[BIN_DIR]}/lib/zsh/git-process-output.zsh"
  elif [[ ! -e ${HOME}/.config/zi/git-process.zsh ]]; then
    typeset tmp_dir=( "${TMPDIR:-/tmp}/zi" )
    [[ -d $tmp_dir ]] || command mkdir -p $tmp_dir 2> /dev/null
    command curl -sL 'https://raw.githubusercontent.com/z-shell/zi/main/lib/zsh/git-process-output.zsh' -o "${tmp_dir}/git-process.zsh"
    command chmod +x "${tmp_dir}/git-process.zsh"
    show_process="${tmp_dir}/git-process.zsh"
  fi
  typeset git_repo="$1" clone_target="$2"
  command git clone --verbose --progress https://github.com/${git_repo} $clone_target |& { command $show_process || cat; }
  return 0
fi
